# SPDX short identifier: BSL-1.0

name: msvc-clangcl-latest
on:
  push:
    paths:
      - '.github/**'
      - 'cmake/**'
      - 'cml/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'CML.cmake'
      - 'vcpkg.json'
      - 'vcpkg-configuration.json'

jobs:
  msvc-clangcl-latest:
    name: MSVC ClangCL Latest
    runs-on: windows-2022
    steps:
      - name: Ensire ClangCL latest is installed
        shell: pwsh
        run: |
          $vspath = 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise'
          Test-Path -Path $vspath | Should -Be $true

          $vsinstaller = 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe'
          Test-Path -Path $vsinstaller | Should -Be $true

          Start-Process -NoNewWindow -Wait -FilePath $vsinstaller -ArgumentList `
            'modify', '--installPath', "`"$vspath`"", '--quiet', '--norestart', '--nocache', '--noUpdateInstaller', `
            '--add', 'Microsoft.VisualStudio.Component.VC.Llvm.Clang', `
            '--add', 'Microsoft.VisualStudio.Component.VC.Llvm.ClangToolset'
      - uses: actions/checkout@v4
      - uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "~3.31.0"
      - uses: lukka/run-vcpkg@v11
      - uses: lukka/run-cmake@v10
        with:
          configurePreset: "cml-ci-ninja-msvc-clangcl-mt-s"
          buildPreset: "cml-ci-ninja-msvc-clangcl-mt-s-release"
          testPreset: "cml-ci-ninja-msvc-clangcl-mt-s-release-test"